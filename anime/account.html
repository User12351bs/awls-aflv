<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval' https://apis.google.com https://accounts.google.com https://www.gstatic.com https://ssl.gstatic.com https://www.googleapis.com https://cdnjs.cloudflare.com blob: data:; frame-src 'self' https://accounts.google.com https://content.googleapis.com; connect-src 'self' https://accounts.google.com https://www.googleapis.com https://oauth2.googleapis.com https://content.googleapis.com;">
    <title>Mi Cuenta - Ureshii Anime</title>
    <link rel="stylesheet" href="index.css">
    <link rel="icon" href="logo.png" type="image/x-icon">
    <link rel="apple-touch-icon" href="logo.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ureshii Anime">
    <script src="glob/localstorage.js"></script>
    <script src="glob/google-drive.js"></script>
    <script src="animes.js"></script>
    <script src="glob/header.js"></script>
    <link rel="stylesheet" href="glob/header.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google API -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        /* Estilos específicos para la página de cuenta */
        :root {
            --card-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
            --card-border-radius: 12px;
            --button-border-radius: 6px;
            --transition-speed: 0.3s;
        }
        
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: 'Avenir', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
        }
        
        .account-container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 1.5rem;
        }
        
        .section-title {
            text-align: center;
            margin-bottom: 2.5rem;
            font-size: 2rem;
            font-weight: 600;
            color: #fff;
            letter-spacing: 0.5px;
        }
        
        .card {
            background-color: var(--card-color);
            border-radius: var(--card-border-radius);
            box-shadow: var(--card-shadow);
            overflow: hidden;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .card-header {
            background-color: rgba(0, 0, 0, 0.2);
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
        }
        
        .card-header h2 {
            margin: 0;
            font-size: 1.4rem;
            font-weight: 600;
            color: #fff;
        }
        
        .card-header i {
            margin-right: 12px;
            font-size: 1.2rem;
            color: var(--accent-color);
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        .section-card {
            background-color: rgba(0, 0, 0, 0.15);
            border-radius: var(--button-border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.03);
        }
        
        .section-card:last-child {
            margin-bottom: 0;
        }
        
        .section-card h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--accent-color);
            display: flex;
            align-items: center;
        }
        
        .section-card h3 i {
            margin-right: 10px;
            font-size: 1.1rem;
        }
        
        .section-card p {
            margin-bottom: 1.25rem;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.95rem;
        }
        
        .btn {
            display: inline-block;
            background-color: var(--accent-color);
            color: #fff;
            border: none;
            border-radius: var(--button-border-radius);
            padding: 0.75rem 1.25rem;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            margin-right: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .btn:hover {
            background-color: #ff8124;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 3px rgba(0, 0, 0, 0.2);
        }
        
        .btn-block {
            display: block;
            width: 100%;
            margin-right: 0;
        }
        
        .btn-google {
            background-color: #4285F4;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-google:hover {
            background-color: #5294ff;
        }
        
        .btn-google i {
            margin-right: 10px;
        }
        
        .drive-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .drive-buttons .btn {
            flex: 1;
            min-width: 120px;
        }
        
        .btn-save {
            background-color: #34A853;
        }
        
        .btn-save:hover {
            background-color: #40c463;
        }
        
        .btn-load {
            background-color: #4285F4;
        }
        
        .btn-load:hover {
            background-color: #5294ff;
        }
        
        .form-control {
            width: 100%;
            background-color: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--button-border-radius);
            padding: 0.75rem 1rem;
            color: #fff;
            font-family: monospace;
            font-size: 0.9rem;
            resize: none;
            transition: border-color var(--transition-speed) ease;
            margin-bottom: 1rem;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(255, 110, 0, 0.25);
        }
        
        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }
        
        .alert {
            padding: 1rem;
            border-radius: var(--button-border-radius);
            margin-top: 1rem;
            font-size: 0.9rem;
            display: none;
        }
        
        .alert-success {
            background-color: rgba(52, 168, 83, 0.15);
            border-left: 3px solid #34A853;
            color: #34A853;
            display: block;
        }
        
        .alert-error {
            background-color: rgba(234, 67, 53, 0.15);
            border-left: 3px solid #EA4335;
            color: #EA4335;
            display: block;
        }
        
        .privacy-notice {
            background-color: rgba(0, 0, 0, 0.15);
            border-radius: var(--button-border-radius);
            padding: 1.5rem;
            margin-top: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.03);
        }
        
        .privacy-notice h4 {
            display: flex;
            align-items: center;
            color: #fff;
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 500;
        }
        
        .privacy-notice h4 i {
            margin-right: 10px;
            color: var(--accent-color);
        }
        
        .privacy-notice p {
            margin-bottom: 1rem;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            line-height: 1.6;
        }
        
        .privacy-notice p:last-child {
            margin-bottom: 0;
        }
        
        /* Media query para pantallas pequeñas */
        @media (max-width: 768px) {
            .account-container {
                padding: 0 1rem;
                margin: 1rem auto;
            }
            
            .section-title {
                margin-bottom: 1.5rem;
                font-size: 1.6rem;
            }
            
            .card-header {
                padding: 1rem;
            }
            
            .card-body {
                padding: 1.25rem;
            }
            
            .section-card {
                padding: 1.25rem;
            }
            
            .btn {
                width: 100%;
                margin-right: 0;
            }
        }
         
         /* Media query para pantallas grandes */
        @media (min-width: 1200px) {
            .account-container {
                max-width: 1100px;
                margin: 3rem auto;
            }
            
            .section-title {
                font-size: 2.5rem;
                margin-bottom: 3rem;
            }
            
            .card-header {
                padding: 1.5rem 2rem;
            }
            
            .card-header h2 {
                font-size: 1.6rem;
            }
            
            .card-body {
                padding: 2rem;
            }
            
            .section-card {
                padding: 2rem;
                margin-bottom: 2rem;
            }
            
            .section-card h3 {
                font-size: 1.4rem;
                margin-bottom: 1.5rem;
            }
            
            .section-card p {
                font-size: 1.05rem;
                margin-bottom: 1.5rem;
            }
            
            .btn {
                padding: 0.85rem 1.5rem;
                font-size: 1.05rem;
            }
            
            .form-control {
                padding: 0.85rem 1.2rem;
                font-size: 1rem;
                margin-bottom: 1.5rem;
            }
        }
        
        /* Media query para pantallas extra grandes */
        @media (min-width: 1600px) {
            .account-container {
                max-width: 1300px;
                margin: 4rem auto;
            }
            
            .section-title {
                font-size: 2.8rem;
            }
            
            .card {
                margin-bottom: 3rem;
            }
            
            .card-header {
                padding: 1.75rem 2.5rem;
            }
            
            .card-header h2 {
                font-size: 1.8rem;
            }
            
            .card-body {
                padding: 2.5rem;
            }
            
            .section-card {
                padding: 2.5rem;
                margin-bottom: 2.5rem;
            }
            
            .btn {
                padding: 1rem 1.75rem;
                font-size: 1.1rem;
            }
        }
        
        /* Estilos para el toggle de auto-sync */
        .auto-sync-toggle {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #4CAF50;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .toggle-label {
            font-weight: 500;
            color: #fff;
        }
        
        .toggle-description {
            color: #aaa;
            font-size: 0.85rem;
            margin-left: auto;
        }
    </style>
</head>
<body>
    <header>
        <div class="menu-button" id="menu-toggle">
            <svg class="menu-ab-svg--wDGx3 header-svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" data-t="menu-svg" aria-hidden="true" role="img"><path class="menu-ab-svg__top--Xgjtj" d="M20 5H4V7H20V5Z"></path><path class="menu-ab-svg__middle--vsB5D" d="M4 11H20V13H4V11Z"></path><path class="menu-ab-svg__bottom--6yklx" d="M20 17H4V19H20V17Z"></path></svg>
        </div>
        <a href="index.html" class="header-logo">
            <picture>
                <source media="(max-width: 768px)" srcset="logo.png">
                <source media="(min-width: 769px)" srcset="horizontal-logo.png">
                <img src="horizontal-logo.png" alt="Ureshii Anime" class="logo-img">
            </picture>
        </a>
        <div class="nav-categories">
            <a href="index.html" class="nav-category">Catálogo</a>
            <a href="novedades.html" class="nav-category">Novedades</a>
        </div>
        <div class="header-buttons">
            <a href="search.html" class="header-button">
                <svg class="header-svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" data-t="search-svg" aria-hidden="true" role="img"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5 19C12.4879 19 14.3164 18.3176 15.7641 17.1742L21.2927 22.7069L22.7074 21.2931L17.1778 15.7595C18.319 14.3126 19 12.4858 19 10.5C19 5.80558 15.1944 2 10.5 2C5.80558 2 2 5.80558 2 10.5C2 15.1944 5.80558 19 10.5 19ZM10.5 17C14.0899 17 17 14.0899 17 10.5C17 6.91015 14.0899 4 10.5 4C6.91015 4 4 6.91015 4 10.5C4 14.0899 6.91015 17 10.5 17Z"></path></svg>
            </a>
            <a href="ureshiilists.html" class="header-button">
                <svg class="header-svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" data-t="watchlist-svg" aria-hidden="true" role="img"><path fill-rule="evenodd" clip-rule="evenodd" d="M19.0001 20.5858C19.0001 21.4767 17.9229 21.9229 17.293 21.2929L12.0001 16L6.7071 21.2929C6.07714 21.9229 5 21.4767 5 20.5858L5.00006 3H19.0001V20.5858ZM7.00001 18.1716L7.00006 5H17.0001V18.1716L12.0001 13.1716L7.00001 18.1716Z"></path></svg>
            </a>
            <a href="account.html" class="export-button" id="export-import-button">
                <svg class="header-svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" data-t="user-settings-svg" aria-hidden="true" role="img"><path d="M12 20a6.01 6.01 0 0 1-5.966-5.355L12 12.088l5.966 2.557A6.01 6.01 0 0 1 12 20m0-16c1.654 0 3 1.346 3 3s-1.345 3-2.999 3h-.002A3.003 3.003 0 0 1 9 7c0-1.654 1.346-3 3-3m7.394 9.081l-4.572-1.959A4.997 4.997 0 0 0 17 7c0-2.757-2.243-5-5-5S7 4.243 7 7c0 1.71.865 3.22 2.178 4.122l-4.572 1.959A.999.999 0 0 0 4 14c0 4.411 3.589 8 8 8s8-3.589 8-8c0-.4-.238-.762-.606-.919"></path></svg>
            </a>
        </div>
    </header>

    <div class="account-container">
        <h1 class="section-title">Mi Cuenta</h1>
        
        <div class="card">
            <div class="card-header">
                <i class="fas fa-sync-alt"></i>
                <h2>Gestión de Datos</h2>
            </div>
            <div class="card-body">
                <!-- Google Drive -->
                <div class="section-card">
                    <h3><i class="fab fa-google-drive"></i> Google Drive</h3>
                    <p>Gestiona tus datos en Google Drive de forma manual.</p>
                    
                    <div class="drive-buttons">
                        <button id="signin-button" class="btn btn-google"><i class="fab fa-google"></i> Iniciar sesión</button>
                        <button id="load-button" class="btn btn-primary" style="display:none;"><i class="fas fa-download"></i> Cargar</button>
                        <button id="save-button" class="btn btn-success" style="display:none;"><i class="fas fa-upload"></i> Guardar</button>
                        <button id="signout-button" class="btn btn-secondary" style="display:none;"><i class="fas fa-sign-out-alt"></i> Cerrar sesión</button>
                    </div>
                    <div id="drive-result" class="alert"></div>
                </div>
                <!-- Exportar manual -->
                <div class="section-card">
                    <h3><i class="fas fa-file-export"></i> Exportar Datos</h3>
                    <p>Genera un código para guardar tus datos y poder recuperarlos más tarde.</p>
                    <button id="generate-export-code" class="btn">Generar Código</button>
                    <div id="export-code-container" style="display: none;">
                        <textarea id="export-code" class="form-control" rows="4" readonly></textarea>
                        <button id="copy-export-code" class="btn">Copiar Código</button>
                    </div>
                </div>
                
                <!-- Importar manual -->
                <div class="section-card">
                    <h3><i class="fas fa-file-import"></i> Importar Datos</h3>
                    <p>Pega tu código para recuperar tus datos guardados anteriormente.</p>
                    <textarea id="import-code" class="form-control" rows="4" placeholder="Pega aquí tu código..."></textarea>
                    <button id="import-data-button" class="btn">Importar Datos</button>
                    <div id="import-result" class="alert"></div>
                </div>
            </div>
        </div>
        
        <!-- Aviso de privacidad -->
        <div class="privacy-notice">
            <h4><i class="fas fa-shield-alt"></i> Información sobre el manejo de datos</h4>
            <p>Todos los datos sincronizados con Google Drive son gestionados directamente por Google y no pasan por nuestros servidores. Ureshii Anime no tiene acceso a tus credenciales ni a la información almacenada en tu cuenta de Google.</p>
            <p>Al utilizar la sincronización con Google Drive, aceptas los términos y condiciones de Google. Tus datos se almacenan únicamente en tu cuenta personal y solo tú tienes control sobre ellos.</p>
            <p>La exportación manual genera un código que puedes guardar donde prefieras. Este código contiene tus listas y progreso, pero no incluye información personal identificable.</p>
        </div>
    </div>
    
    <script>
        // Esperar a que el DOM y todos los scripts se carguen
        document.addEventListener('DOMContentLoaded', function() {
            // ============================
            // EXPORTAR / IMPORTAR MANUAL
            // ============================
            let watchedEpisodes = JSON.parse(localStorage.getItem(window.WATCHED_EPISODES_KEY)) || {};
            let myList = JSON.parse(localStorage.getItem(window.MY_LIST_KEY)) || [];
            let watchingAnimes = JSON.parse(localStorage.getItem(window.WATCHING_ANIMES_KEY)) || [];

        const generateExportCode = document.getElementById('generate-export-code');
        const exportCodeContainer = document.getElementById('export-code-container');
        const exportCode = document.getElementById('export-code');
        const copyExportCode = document.getElementById('copy-export-code');
        const importCode = document.getElementById('import-code');
        const importDataButton = document.getElementById('import-data-button');
        const importResult = document.getElementById('import-result');

        generateExportCode.addEventListener('click', () => {
            const userData = { watchedEpisodes, myList, watchingAnimes };
            exportCode.value = btoa(JSON.stringify(userData));
            exportCodeContainer.style.display = 'block';
        });

        copyExportCode.addEventListener('click', () => {
            exportCode.select();
            document.execCommand('copy');
            const originalText = copyExportCode.textContent;
            copyExportCode.textContent = '¡Copiado!';
            setTimeout(() => copyExportCode.textContent = originalText, 2000);
        });

        importDataButton.addEventListener('click', () => {
            try {
                const encodedData = importCode.value.trim();
                if (!encodedData) throw new Error('Por favor, introduce un código válido');
                const userData = JSON.parse(atob(encodedData));
                if (!userData.watchedEpisodes || !userData.myList || !userData.watchingAnimes) {
                    throw new Error('El código no contiene datos válidos');
                }
                watchedEpisodes = userData.watchedEpisodes;
                myList = userData.myList;
                watchingAnimes = userData.watchingAnimes;
                localStorage.setItem(window.WATCHED_EPISODES_KEY, JSON.stringify(watchedEpisodes));
                localStorage.setItem(window.MY_LIST_KEY, JSON.stringify(myList));
                localStorage.setItem(window.WATCHING_ANIMES_KEY, JSON.stringify(watchingAnimes));
                importResult.textContent = '¡Datos importados correctamente!';
                importResult.className = 'alert alert-success';
                importCode.value = '';
            } catch (e) {
                importResult.textContent = `Error: ${e.message}`;
                importResult.className = 'alert alert-error';
            }
        });

        // ============================
        // GOOGLE DRIVE - SISTEMA MANUAL
        // ============================
        const signinButton = document.getElementById('signin-button');
        const loadButton = document.getElementById('load-button');
        const saveButton = document.getElementById('save-button');
        const signoutButton = document.getElementById('signout-button');
        const driveResult = document.getElementById('drive-result');

        // Botón de iniciar sesión
        signinButton.onclick = async () => {
            if (window.googleDrive && window.googleDrive.signIn) {
                try {
                    driveResult.textContent = "⏳ Iniciando sesión...";
                    driveResult.className = "alert alert-info";
                    
                    await window.googleDrive.signIn();
                    
                    signinButton.style.display = "none";
                    loadButton.style.display = "inline-block";
                    saveButton.style.display = "inline-block";
                    signoutButton.style.display = "inline-block";
                    driveResult.textContent = "✅ Conectado con Google Drive";
                    driveResult.className = "alert alert-success";
                } catch (error) {
                    driveResult.textContent = "❌ Error al iniciar sesión: " + error.message;
                    driveResult.className = "alert alert-error";
                }
            } else {
                driveResult.textContent = "❌ Sistema de Google Drive no disponible";
                driveResult.className = "alert alert-error";
            }
        };
        
        // Botón de cargar
        loadButton.onclick = async () => {
            if (window.manualLoadFromDrive) {
                try {
                    driveResult.textContent = "⏳ Cargando datos...";
                    driveResult.className = "alert alert-info";
                    await window.manualLoadFromDrive();
                    driveResult.textContent = "✅ Datos cargados desde Google Drive";
                    driveResult.className = "alert alert-success";
                    // Recargar la página para mostrar los datos actualizados
                    setTimeout(() => location.reload(), 1000);
                } catch (error) {
                    driveResult.textContent = "❌ Error al cargar: " + error.message;
                    driveResult.className = "alert alert-error";
                }
            }
        };
        
        // Botón de guardar
        saveButton.onclick = async () => {
            if (window.manualSaveToDrive) {
                try {
                    driveResult.textContent = "⏳ Guardando datos...";
                    driveResult.className = "alert alert-info";
                    await window.manualSaveToDrive();
                    driveResult.textContent = "✅ Datos guardados en Google Drive";
                    driveResult.className = "alert alert-success";
                } catch (error) {
                    driveResult.textContent = "❌ Error al guardar: " + error.message;
                    driveResult.className = "alert alert-error";
                }
            }
        };
        
        // Botón de cerrar sesión
        signoutButton.onclick = async () => {
            if (window.googleDrive && window.googleDrive.signOut) {
                await window.googleDrive.signOut();
                signinButton.style.display = "inline-block";
                loadButton.style.display = "none";
                saveButton.style.display = "none";
                signoutButton.style.display = "none";
                driveResult.textContent = "Desconectado de Google Drive";
                driveResult.className = "alert alert-info";
            }
        };
        
        // Inicializar Google Drive
        if (window.googleDrive && window.googleDrive.initialize) {
            window.googleDrive.initialize().then(() => {
                console.log('Google Drive inicializado correctamente');
                // Verificar estado inicial después de la inicialización
                if (window.googleDrive.isConnected()) {
                    signinButton.style.display = "none";
                    loadButton.style.display = "inline-block";
                    saveButton.style.display = "inline-block";
                    signoutButton.style.display = "inline-block";
                    driveResult.textContent = "✅ Conectado con Google Drive";
                    driveResult.className = "alert alert-success";
                }
            }).catch(error => {
                console.error('Error al inicializar Google Drive:', error);
                driveResult.textContent = "❌ Error al inicializar Google Drive: " + error.message;
                driveResult.className = "alert alert-error";
            });
        } else {
            console.error('Google Drive no disponible');
            driveResult.textContent = "❌ Google Drive no disponible";
            driveResult.className = "alert alert-error";
        }

        }); // Fin del DOMContentLoaded
    </script>
</body>
</html>
