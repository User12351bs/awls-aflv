<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ureshii Anime</title>
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="glob/header.css">
    <script src="glob/header.js"></script>
    <link rel="icon" href="logo.png" type="image/x-icon">
    <link rel="apple-touch-icon" href="logo.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ureshii Anime">
    <script src="glob/localstorage.js"></script>
    <script src="glob/google-drive.js"></script>
    <script src="animes.js"></script>
    <style>
        /* Estilos para desactivar el scroll en la página principal */
        html, body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000;
            color: white;
            min-height: 100vh;
        }
        
        /* Estilos específicos para el visor */
        .viewer-container {
            width: 100%;
            min-height: calc(100vh - var(--header-height));
            position: relative;
            background: #000;
            display: flex;
            flex-direction: column;
        }
        
        .blue-background {
            position: absolute;
            bottom: var(--toolbar-height);
            left: 0;
            right: 0;
            height: 200px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            z-index: 1;
        }
        
        .title-badge {
            display: none;
        }
        
        /* Fondo con imagen de anime */
        .viewer-background {
            display: none;
        }
        
        /* Contenedor principal del episodio */
        .episode-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 0;
            position: relative;
            z-index: 5;
        }
        
        /* Título del episodio estilizado */
        .episode-title {
            display: none;
        }
        
        /* Información del anime */
        .anime-info {
            display: none;
        }
        
        /* Contenedor del reproductor */
        .player-container {
            position: fixed;
            top: var(--header-height);
            left: 0;
            right: 0;
            bottom: calc(var(--toolbar-height));
            background: rgba(0,0,0,0.9);
            border-radius: 0;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1;
        }
        
        .embed-container {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 0;
        }
        
        /* Ajustes para el reproductor embebido */
        #anime-iframe {
            display: block;
            width: 100%;
            height: 120%;
            border: none;
            margin-top: -130px;
            transform: scale(1.05);
            transform-origin: center top;
            overflow: hidden;
            scrolling: no;
            pointer-events: auto;
        }
        
        /* Prevenir scroll en el iframe */
        .player-container {
            overflow: hidden !important;
        }
        
        /* Barra de herramientas rediseñada */
        :root {
            --toolbar-height: 80px;
        }
        
        .toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--toolbar-height);
            background: linear-gradient(135deg, rgba(26,26,46,0.95), rgba(22,33,62,0.95));
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.3);
            border-top: 1px solid rgba(255,107,53,0.2);
            padding: 15px 0;
        }
        
        .anime-info-small {
            position: fixed;
            bottom: calc(var(--toolbar-height) + 15px);
            left: 50%;
            transform: translateX(-50%);
            color: #ffffff;
            font-size: 0.9rem;
            opacity: 1;
            text-align: center;
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 24px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            max-width: calc(100% - 40px);
            z-index: 999;
        }
        
        .toolbar-nav {
            display: flex;
            gap: 20px;
            align-items: center;
            margin: 0;
        }
        
        .toolbar-button {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255,107,53,0.3);
            min-width: 140px;
        }
        
        .toolbar-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255,107,53,0.4);
            background: linear-gradient(135deg, #f7931e, #ff6b35);
        }
        
        .toolbar-button:disabled {
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.5);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .toolbar-button.home {
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .toolbar-button.home:hover {
            background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1));
            border-color: rgba(255,255,255,0.3);
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,107,53,0.2);
            border-radius: 50%;
            border-top-color: #ff6b35;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }
        
        .loading-text {
            color: #ffffff;
            font-size: 1.1rem;
            opacity: 0.8;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Ocultar iframe hasta que se cargue */
        #anime-iframe.hidden {
            display: none;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .player-container {
                left: 10px;
                right: 10px;
                bottom: calc(var(--toolbar-height) + 70px);
            }
            
            .anime-info-small {
                font-size: 0.8rem;
                padding: 6px 20px;
                max-width: calc(100% - 20px);
                bottom: calc(var(--toolbar-height) + 20px);
            }
            
            .title-badge {
                display: none;
            }
            
            .toolbar-nav {
                gap: 10px;
                padding: 0 10px;
            }
            
            .toolbar-button {
                padding: 10px 16px;
                font-size: 0.8rem;
                min-width: 100px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="menu-button" id="menu-toggle">
            <svg class="menu-ab-svg--wDGx3 header-svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" data-t="menu-svg" aria-hidden="true" role="img"><path class="menu-ab-svg__top--Xgjtj" d="M20 5H4V7H20V5Z"></path><path class="menu-ab-svg__middle--vsB5D" d="M4 11H20V13H4V11Z"></path><path class="menu-ab-svg__bottom--6yklx" d="M20 17H4V19H20V17Z"></path></svg>
        </div>
        <a href="index.html" class="header-logo">
            <picture>
                <source media="(max-width: 768px)" srcset="logo.png">
                <source media="(min-width: 769px)" srcset="horizontal-logo.png">
                <img src="horizontal-logo.png" alt="Ureshii Anime" class="logo-img">
            </picture>
        </a>
        <div class="nav-categories">
            <a href="index.html" class="nav-category">Catálogo</a>
            <a href="novedades.html" class="nav-category">Novedades</a>
        </div>
        <div class="header-buttons">
            <a href="search.html" class="header-button">
                <svg class="header-svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" data-t="search-svg" aria-hidden="true" role="img"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5 19C12.4879 19 14.3164 18.3176 15.7641 17.1742L21.2927 22.7069L22.7074 21.2931L17.1778 15.7595C18.319 14.3126 19 12.4858 19 10.5C19 5.80558 15.1944 2 10.5 2C5.80558 2 2 5.80558 2 10.5C2 15.1944 5.80558 19 10.5 19ZM10.5 17C14.0899 17 17 14.0899 17 10.5C17 6.91015 14.0899 4 10.5 4C6.91015 4 4 6.91015 4 10.5C4 14.0899 6.91015 17 10.5 17Z"></path></svg>
            </a>
            <a href="ureshiilists.html" class="header-button">
                <svg class="header-svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" data-t="watchlist-svg" aria-hidden="true" role="img"><path fill-rule="evenodd" clip-rule="evenodd" d="M19.0001 20.5858C19.0001 21.4767 17.9229 21.9229 17.293 21.2929L12.0001 16L6.7071 21.2929C6.07714 21.9229 5 21.4767 5 20.5858L5.00006 3H19.0001V20.5858ZM7.00001 18.1716L7.00006 5H17.0001V18.1716L12.0001 13.1716L7.00001 18.1716Z"></path></svg>
            </a>
            <a href="account.html" class="export-button" id="export-import-button">
                <svg class="header-svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" data-t="user-settings-svg" aria-hidden="true" role="img"><path d="M12 20a6.01 6.01 0 0 1-5.966-5.355L12 12.088l5.966 2.557A6.01 6.01 0 0 1 12 20m0-16c1.654 0 3 1.346 3 3s-1.345 3-2.999 3h-.002A3.003 3.003 0 0 1 9 7c0-1.654 1.346-3 3-3m7.394 9.081l-4.572-1.959A4.997 4.997 0 0 0 17 7c0-2.757-2.243-5-5-5S7 4.243 7 7c0 1.71.865 3.22 2.178 4.122l-4.572 1.959A.999.999 0 0 0 4 14c0 4.411 3.589 8 8 8s8-3.589 8-8c0-.4-.238-.762-.606-.919"></path></svg>
            </a>
        </div>
    </header>

    <div class="viewer-container" id="viewer-container">
        <div class="viewer-background"></div>
        <div class="blue-background"></div>
        <div class="title-badge" id="title-badge">Preparando reproductor...</div>
        
        <div class="loading-overlay" id="loading-overlay">
            <div class="spinner"></div>
            <div class="loading-text">Cargando episodio...</div>
        </div>
        
        <div class="episode-container">
            <h1 class="episode-title" id="episode-title">DAN DA DAN 2 - Temporada 2 - Episodio 8</h1>
            <div class="anime-info" id="anime-info">Preparando reproductor...</div>
            
            <div class="player-container">
                <iframe id="anime-iframe" class="embed-container" allowfullscreen></iframe>
            </div>
    
    <div class="anime-info-small" id="anime-info-small">Preparando reproductor...</div>
    
    <div class="toolbar">
        <div class="toolbar-nav">
            <button class="toolbar-button home" id="home-button">Volver</button>
            <button class="toolbar-button" id="next-episode">Episodio Siguiente</button>
        </div>
    </div>

    <script>
        // Elementos DOM
        const animeIframe = document.getElementById('anime-iframe');
        const homeButton = document.getElementById('home-button');
        const nextEpisodeButton = document.getElementById('next-episode');
        const loadingOverlay = document.getElementById('loading-overlay');
        const episodeTitle = document.getElementById('episode-title');
        const animeInfo = document.getElementById('anime-info');
        const animeInfoSmall = document.getElementById('anime-info-small');
        const titleBadge = document.getElementById('title-badge');
        
        // Obtener parámetros iniciales de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const animeId = urlParams.get('id');
        const seasonNumber = parseInt(urlParams.get('season')) || 1;
        let episodeNumber = parseInt(urlParams.get('episode')) || 1;
        
        // Crear una variable global para el número de episodio
        window.episodeNumber = episodeNumber;
        
        console.log("[INIT] Parámetros iniciales:", { animeId, seasonNumber, episodeNumber });
        
        // Función para actualizar parámetros desde la URL actual
        function updateParamsFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const newEpisodeNumber = parseInt(urlParams.get('episode')) || 1;
            
            console.log("[INIT] Actualizando parámetros desde URL:", {
                episodeAnterior: window.episodeNumber,
                episodeNuevo: newEpisodeNumber,
                url: window.location.href
            });
            
            // Actualizar variables globales
            episodeNumber = newEpisodeNumber;
            window.episodeNumber = newEpisodeNumber;
            
            return {
                animeId: urlParams.get('id'),
                seasonNumber: parseInt(urlParams.get('season')) || 1,
                episodeNumber: newEpisodeNumber
            };
        }
        
        // Cargar datos del localStorage
        const watchedEpisodes = JSON.parse(localStorage.getItem(WATCHED_EPISODES_KEY)) || {};
        
        // Encontrar el anime actual
        const currentAnime = animeData.find(anime => anime.id.toString() === animeId);
        const currentSeason = currentAnime ? currentAnime.seasons.find(season => season.number === seasonNumber) : null;
        
        // Función para marcar episodio como visto
        function markEpisodeAsWatched(animeId, episodeNumber) {
            if (!watchedEpisodes[animeId]) {
                watchedEpisodes[animeId] = [];
            }
            
            if (!watchedEpisodes[animeId].includes(episodeNumber)) {
                watchedEpisodes[animeId].push(episodeNumber);
                localStorage.setItem(WATCHED_EPISODES_KEY, JSON.stringify(watchedEpisodes));
                
                // También actualizar watchingAnimes si es necesario
                let watchingAnimes = JSON.parse(localStorage.getItem(WATCHING_ANIMES_KEY)) || [];
                
                if (!watchingAnimes.includes(animeId)) {
                    watchingAnimes.push(animeId);
                    localStorage.setItem(WATCHING_ANIMES_KEY, JSON.stringify(watchingAnimes));
                }
            }
        }
        
        // Función para obtener el número global del episodio
        function getGlobalEpisodeNumber(anime, seasonNumber, episodeNumber) {
            let globalEpisode = episodeNumber;
            
            for (let i = 0; i < anime.seasons.length; i++) {
                const season = anime.seasons[i];
                if (season.number < seasonNumber) {
                    globalEpisode += season.episodes;
                }
            }
            
            return globalEpisode;
        }
        
        // Nueva función para actualizar la información del episodio
        function updateEpisodeInfo() {
            if (currentAnime && currentSeason) {
                const seasonTitle = currentSeason.title || `Temporada ${seasonNumber}`;
                episodeTitle.textContent = `${currentAnime.title.toUpperCase()} - ${seasonTitle} - Episodio ${window.episodeNumber}`;
                animeInfo.textContent = `Reproduciendo: ${currentAnime.title}`;
                animeInfoSmall.textContent = `${currentAnime.title} - ${seasonTitle} - Episodio ${window.episodeNumber}`;
                titleBadge.textContent = `${currentAnime.title} - ${seasonTitle} - Episodio ${window.episodeNumber}`;
            }
        }

        // Función para cargar el episodio
        function loadEpisode() {
            if (!currentAnime || !currentSeason) {
                alert('Anime o temporada no encontrados');
                window.location.href = 'index.html';
                return;
            }
            
            // Mostrar pantalla de carga
            loadingOverlay.style.display = 'flex';
            
            // Construir la URL para el episodio
            const seasonSlug = currentSeason.slug || currentAnime.slug || currentAnime.title.toLowerCase().replace(/\s+/g, '-');
            
            // Construir la URL que apunta a la página del episodio
            const animeFlvUrl = `https://www3.animeflv.net/ver/${seasonSlug}-${window.episodeNumber}`;
            
            // Cargar la URL directamente en el iframe
            animeIframe.src = animeFlvUrl;
            animeIframe.classList.remove('hidden');
            
            // Marcar el episodio como visto
            const globalEpisodeNumber = getGlobalEpisodeNumber(currentAnime, seasonNumber, window.episodeNumber);
            markEpisodeAsWatched(currentAnime.id, globalEpisodeNumber);
            
            // Actualizar estado de los botones de navegación
            updateNavigationButtons();
            
            // Actualizar la información del episodio
            updateEpisodeInfo();
        }
        
        // Función para actualizar los botones de navegación
        function updateNavigationButtons() {
            // Episodio siguiente
            if (window.episodeNumber < currentSeason.episodes) {
                nextEpisodeButton.disabled = false;
            } else {
                // Verificar si hay temporada siguiente
                const nextSeason = currentAnime.seasons.find(season => season.number === seasonNumber + 1);
                nextEpisodeButton.disabled = !nextSeason;
            }
        }
        
        // Función para navegar al episodio anterior
        function goToPreviousEpisode() {
            if (window.episodeNumber > 1) {
                // Ir al episodio anterior en la misma temporada
                window.location.href = `viewer.html?id=${animeId}&season=${seasonNumber}&episode=${window.episodeNumber - 1}`;
            } else if (seasonNumber > 1) {
                // Ir al último episodio de la temporada anterior
                const prevSeason = currentAnime.seasons.find(season => season.number === seasonNumber - 1);
                if (prevSeason) {
                    window.location.href = `viewer.html?id=${animeId}&season=${seasonNumber - 1}&episode=${prevSeason.episodes}`;
                }
            }
        }
        
        // Función para navegar al episodio siguiente
        function goToNextEpisode() {
            if (window.episodeNumber < currentSeason.episodes) {
                // Ir al siguiente episodio en la misma temporada
                window.location.href = `viewer.html?id=${animeId}&season=${seasonNumber}&episode=${window.episodeNumber + 1}`;
            } else {
                // Ir al primer episodio de la siguiente temporada
                const nextSeason = currentAnime.seasons.find(season => season.number === seasonNumber + 1);
                if (nextSeason) {
                    window.location.href = `viewer.html?id=${animeId}&season=${seasonNumber + 1}&episode=1`;
                }
            }
        }
        
        // Función para volver a la página de inicio
        function goToHome() {
            // Si venimos de una página de anime, volver a ella
            if (animeId) {
                window.location.href = `anime.html?id=${animeId}`;
            } else {
                // Si no, volver a la página principal
                window.location.href = 'index.html';
            }
        }
        
        // Evento para el botón de inicio
        homeButton.addEventListener('click', () => {
        // Si venimos de una página de anime, volver a ella
        if (animeId) {
        window.location.href = `anime.html?id=${animeId}`;
        } else {
        // Si no, volver a la página principal
        window.location.href = 'index.html';
        }
        });
        
        // Event listeners
        animeIframe.addEventListener('load', () => {
            // Ocultar pantalla de carga cuando el iframe se cargue
            loadingOverlay.style.display = 'none';
            
            console.log("Iframe cargado, URL actual:", animeIframe.src);
            
            // La detección continua se inicia automáticamente desde el nuevo sistema
        });
        
        // Escuchar cambios en la URL del iframe indirectamente
        // Esto requiere que estemos ejecutando en un servidor local
        window.addEventListener('message', function(event) {
            // Verificar origen por seguridad (opcional)
            console.log("Mensaje recibido:", event.data);
            
            // Procesar mensajes si contienen información de navegación
            if (event.data && event.data.newEpisode) {
                updateToNewEpisode(event.data.newEpisode);
            }
        });
        
        // Función para actualizar la interfaz cuando cambia el episodio
        function updateToNewEpisode(newEpisodeNumber) {
            console.log("[UPDATE] Intentando actualizar al episodio", newEpisodeNumber, "desde", window.episodeNumber);
            console.log("[UPDATE] Tipos:", typeof newEpisodeNumber, typeof window.episodeNumber);
            
            // Convertir a número para asegurar comparación correcta
            newEpisodeNumber = parseInt(newEpisodeNumber);
            const currentEpisode = parseInt(window.episodeNumber);
            
            console.log("[UPDATE] Después de parseInt:", newEpisodeNumber, "vs", currentEpisode);
            
            if (newEpisodeNumber !== currentEpisode) {
                console.log("[UPDATE] ✅ Actualizando al episodio", newEpisodeNumber);
                
                // Actualizar variables locales
                window.episodeNumber = newEpisodeNumber;
                episodeNumber = newEpisodeNumber; // Actualizar también la variable local
                
                // Actualizar la URL del navegador sin recargar la página
                const newUrl = `viewer.html?id=${animeId}&season=${seasonNumber}&episode=${newEpisodeNumber}`;
                window.history.replaceState({}, '', newUrl);
                
                // También actualizar la URL completa en la barra de direcciones
                const fullUrl = `${window.location.origin}${window.location.pathname}?id=${animeId}&season=${seasonNumber}&episode=${newEpisodeNumber}`;
                window.history.replaceState({}, '', fullUrl);
                
                console.log("URL actualizada a:", fullUrl);
                
                // Marcar el nuevo episodio como visto
                const globalEpisodeNumber = getGlobalEpisodeNumber(currentAnime, seasonNumber, newEpisodeNumber);
                markEpisodeAsWatched(currentAnime.id, globalEpisodeNumber);
                
                // Actualizar la información del episodio
                updateEpisodeInfo();
                
                // Actualizar botones de navegación
                updateNavigationButtons();
                
                // Forzar actualización visual con un truco de DOM
                if (episodeTitle) {
                    episodeTitle.style.opacity = '0';
                    setTimeout(() => {
                        episodeTitle.style.opacity = '1';
                        // Forzar un reflow
                        episodeTitle.offsetHeight;
                    }, 10);
                }
                
                console.log("Interfaz actualizada para el episodio", newEpisodeNumber);
            }
        }
        
        // Sistema mejorado de detección de cambios en el iframe
        let lastSrc = animeIframe.src;
        let lastContent = '';
        let detectionInterval;
        
        // Función para extraer información de anime desde URL
        function extractAnimeInfoFromUrl(url) {
            // Patrones para diferentes formatos de URL de AnimeFlv
            const patterns = [
                /\/ver\/([\w-]+)-([0-9]+)$/,  // /ver/anime-slug-episodio
                /\/ver\/([\w-]+)-temporada-([0-9]+)-([0-9]+)$/,  // /ver/anime-slug-temporada-X-episodio
                /\/ver\/([\w-]+)-s([0-9]+)-([0-9]+)$/,  // /ver/anime-slug-sX-episodio
                /\/ver\/([\w-]+)-season-([0-9]+)-([0-9]+)$/  // /ver/anime-slug-season-X-episodio
            ];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) {
                    if (match.length === 3) {
                        // Formato simple: anime-slug-episodio
                        return {
                            animeSlug: match[1],
                            season: 1,
                            episode: parseInt(match[2])
                        };
                    } else if (match.length === 4) {
                        // Formato con temporada: anime-slug-temporada-X-episodio
                        return {
                            animeSlug: match[1],
                            season: parseInt(match[2]),
                            episode: parseInt(match[3])
                        };
                    }
                }
            }
            
            return null;
        }
        
        // Función para encontrar anime por slug
        function findAnimeBySlug(slug) {
            return animeData.find(anime => {
                // Verificar slug principal
                if (anime.slug === slug) return true;
                
                // Verificar slugs de temporadas
                return anime.seasons.some(season => season.slug === slug);
            });
        }
        
        // Función mejorada para actualizar cuando cambia el contenido
        function updateFromDetectedChange(newAnimeInfo) {
            console.log("Información detectada:", newAnimeInfo);
            
            // Buscar el anime correspondiente
            const detectedAnime = findAnimeBySlug(newAnimeInfo.animeSlug);
            
            if (detectedAnime) {
                // Verificar si cambió el anime
                if (detectedAnime.id.toString() !== animeId) {
                    console.log("Cambio de anime detectado, redirigiendo...");
                    window.location.href = `viewer.html?id=${detectedAnime.id}&season=${newAnimeInfo.season}&episode=${newAnimeInfo.episode}`;
                    return;
                }
                
                // Verificar si cambió la temporada
                if (newAnimeInfo.season !== seasonNumber) {
                    console.log("Cambio de temporada detectado, redirigiendo...");
                    window.location.href = `viewer.html?id=${animeId}&season=${newAnimeInfo.season}&episode=${newAnimeInfo.episode}`;
                    return;
                }
                
                // Solo cambió el episodio
                if (newAnimeInfo.episode !== parseInt(window.episodeNumber)) {
                    console.log("Cambio de episodio detectado:", newAnimeInfo.episode);
                    updateToNewEpisode(newAnimeInfo.episode);
                }
            } else {
                console.log("No se encontró anime para el slug:", newAnimeInfo.animeSlug);
            }
        }
        
        // Función para configurar MutationObserver en el iframe
        function setupIframeMutationObserver() {
            try {
                const iframeDocument = animeIframe.contentDocument || animeIframe.contentWindow.document;
                if (iframeDocument) {
                    const observer = new MutationObserver((mutations) => {
                        console.log("[MUTATION] Cambio detectado en el DOM del iframe");
                        
                        // Buscar cambios en elementos que puedan contener el número de episodio
                        mutations.forEach((mutation) => {
                            if (mutation.type === 'childList' || mutation.type === 'characterData') {
                                // Verificar si hay cambios en el título
                                const newTitle = iframeDocument.title;
                                if (newTitle && newTitle !== lastTitle) {
                                    console.log("[MUTATION] Título cambió:", newTitle);
                                    lastTitle = newTitle;
                                    
                                    // Buscar episodio en el nuevo título
                                    const episodeMatch = newTitle.match(/(?:episodio|capitulo|cap|ep)\s*([0-9]+)/i);
                                    if (episodeMatch) {
                                        const detectedEpisode = parseInt(episodeMatch[1]);
                                        if (detectedEpisode !== parseInt(window.episodeNumber)) {
                                            console.log("[MUTATION] Episodio detectado desde título:", detectedEpisode);
                                            updateToNewEpisode(detectedEpisode);
                                        }
                                    }
                                }
                            }
                        });
                    });
                    
                    observer.observe(iframeDocument, {
                        childList: true,
                        subtree: true,
                        characterData: true
                    });
                    
                    console.log("[MUTATION] Observer configurado correctamente");
                    return observer;
                }
            } catch (error) {
                console.log("[MUTATION] No se pudo configurar observer (CORS):", error.message);
            }
            return null;
        }
        
        // Variable para el título anterior
        let lastTitle = '';
        let mutationObserver = null;
        
        // Iniciar detección continua mejorada
        function startContinuousDetection() {
            console.log("Iniciando detección continua mejorada...");
            console.log("Episodio actual:", window.episodeNumber);
            
            // Configurar MutationObserver
            mutationObserver = setupIframeMutationObserver();
            
            detectionInterval = setInterval(() => {
                console.log("[DEBUG] Verificando cambios... Episodio actual:", window.episodeNumber);
                
                // Verificar cambios en la URL del iframe
                if (animeIframe.src !== lastSrc) {
                    console.log("[DETECCIÓN] Cambio detectado en iframe.src:", animeIframe.src);
                    lastSrc = animeIframe.src;
                    
                    // Extraer información de la nueva URL
                    const animeInfo = extractAnimeInfoFromUrl(animeIframe.src);
                    if (animeInfo) {
                        console.log("[DETECCIÓN] Información extraída de URL:", animeInfo);
                        updateFromDetectedChange(animeInfo);
                    } else {
                        console.log("[DETECCIÓN] No se pudo extraer información de la URL:", animeIframe.src);
                    }
                }
                
                // Intentar acceder al contenido del iframe (puede fallar por CORS)
                try {
                    const iframeDocument = animeIframe.contentDocument || animeIframe.contentWindow.document;
                    const iframeTitle = iframeDocument.title;
                    const currentUrl = iframeDocument.location.href;
                    
                    console.log("[DEBUG] URL interna actual:", currentUrl);
                    console.log("[DEBUG] URL guardada:", lastSrc);
                    console.log("[DEBUG] Episodio actual:", window.episodeNumber);
                    
                    // Verificar si la URL interna del iframe cambió
                    if (currentUrl && currentUrl !== lastSrc) {
                        console.log("[DETECCIÓN] URL interna del iframe cambió:", currentUrl);
                        lastSrc = currentUrl;
                        
                        // Intentar extraer episodio directamente de la URL con patrones más amplios
                        const urlEpisodePatterns = [
                            /\/episodio-([0-9]+)/i,
                            /\/capitulo-([0-9]+)/i,
                            /\/cap-([0-9]+)/i,
                            /\/ep-([0-9]+)/i,
                            /episode=([0-9]+)/i,
                            /capitulo=([0-9]+)/i,
                            /cap=([0-9]+)/i,
                            /ep=([0-9]+)/i,
                            /\/([0-9]+)\/?$/,
                            /-([0-9]+)\/?$/
                        ];
                        
                        let detectedEpisode = null;
                        for (const pattern of urlEpisodePatterns) {
                            const match = currentUrl.match(pattern);
                            if (match && match[1]) {
                                detectedEpisode = parseInt(match[1]);
                                console.log("[DETECCIÓN] Episodio detectado desde URL con patrón:", pattern, "-> Episodio:", detectedEpisode);
                                break;
                            }
                        }
                        
                        if (detectedEpisode && detectedEpisode !== parseInt(window.episodeNumber) && detectedEpisode <= 100) {
                            console.log("[DETECCIÓN] ¡Cambio de episodio detectado desde URL!", detectedEpisode, "vs", window.episodeNumber);
                            updateToNewEpisode(detectedEpisode);
                        } else {
                            // Si no se puede extraer de la URL, intentar desde el título
                            console.log("[DETECCIÓN] Intentando extraer desde título:", iframeTitle);
                            const episodeMatch = iframeTitle.match(/(?:episodio|capitulo|cap|ep)\s*([0-9]+)/i);
                            if (episodeMatch) {
                                const titleEpisode = parseInt(episodeMatch[1]);
                                console.log("[DETECCIÓN] Episodio detectado desde título de URL:", titleEpisode);
                                if (titleEpisode !== parseInt(window.episodeNumber) && titleEpisode <= 100) {
                                    updateToNewEpisode(titleEpisode);
                                }
                            }
                        }
                    }
                    
                    // Buscar patrones en el título con más variaciones
                    const titlePatterns = [
                        /([\w\s\-\.]+)\s+Episodio\s+([0-9]+)/i,
                        /([\w\s\-\.]+)\s+Capitulo\s+([0-9]+)/i,
                        /([\w\s\-\.]+)\s+Cap\s+([0-9]+)/i,
                        /([\w\s\-\.]+)\s+Ep\s+([0-9]+)/i,
                        /([\w\s\-\.]+)\s+([0-9]+)$/i,
                        /Episodio\s+([0-9]+)/i,
                        /Capitulo\s+([0-9]+)/i,
                        /Cap\s+([0-9]+)/i,
                        /Ep\s+([0-9]+)/i
                    ];
                    
                    console.log("[DEBUG] Título del iframe:", iframeTitle);
                    
                    for (const pattern of titlePatterns) {
                        const match = iframeTitle.match(pattern);
                        if (match) {
                            let detectedEpisode;
                            
                            if (match.length === 3) {
                                // Formato: Anime Episodio X
                                detectedEpisode = parseInt(match[2]);
                            } else if (match.length === 2) {
                                // Formato: Episodio X
                                detectedEpisode = parseInt(match[1]);
                            }
                            
                            console.log("[DEBUG] Episodio detectado desde título:", detectedEpisode, "vs actual:", parseInt(window.episodeNumber));
                            
                            if (detectedEpisode && detectedEpisode !== parseInt(window.episodeNumber)) {
                                console.log("[DETECCIÓN] Cambio detectado desde título - Episodio:", detectedEpisode, "(título:", iframeTitle, ")");
                                updateToNewEpisode(detectedEpisode);
                            }
                            break;
                        }
                    }
                    
                    // Verificar cambios en el contenido HTML con patrones más específicos
                    const iframeContent = iframeDocument.documentElement.innerHTML;
                    if (iframeContent !== lastContent) {
                        lastContent = iframeContent;
                        
                        // Buscar patrones específicos de AnimeFlv en el HTML
                        const htmlPatterns = [
                            /data-episode=["']([0-9]+)["']/i,
                            /episode["']?:\s*["']?([0-9]+)["']?/i,
                            /capitulo["']?:\s*["']?([0-9]+)["']?/i,
                            /"episode":\s*([0-9]+)/i,
                            /"capitulo":\s*([0-9]+)/i,
                            /episodio["']?:\s*["']?([0-9]+)["']?/i,
                            /cap["']?:\s*["']?([0-9]+)["']?/i,
                            /<h1[^>]*>.*?Episodio\s+([0-9]+).*?<\/h1>/i,
                            /<title[^>]*>.*?Episodio\s+([0-9]+).*?<\/title>/i,
                            /class=["'][^"']*episode[^"']*["'][^>]*>.*?([0-9]+)/i
                        ];
                        
                        for (const pattern of htmlPatterns) {
                            const match = iframeContent.match(pattern);
                            if (match && match[1]) {
                                const detectedEpisode = parseInt(match[1]);
                                if (detectedEpisode && detectedEpisode !== parseInt(window.episodeNumber)) {
                                    console.log("Cambio detectado desde HTML - Episodio:", detectedEpisode);
                                    updateToNewEpisode(detectedEpisode);
                                    break;
                                }
                            }
                        }
                        
                        // Buscar elementos específicos del DOM de AnimeFlv
                        const episodeSelectors = [
                            '[data-episode]',
                            '.episode-number',
                            '.cap-number', 
                            '.episode-title',
                            '.episode-info',
                            '.current-episode',
                            '.episode-current',
                            '.ep-number',
                            '.episode',
                            '.capitulo',
                            'h1',
                            'h2',
                            '.title'
                        ];
                        
                        episodeSelectors.forEach(selector => {
                            try {
                                const elements = iframeDocument.querySelectorAll(selector);
                                elements.forEach(element => {
                                    const text = element.textContent || element.getAttribute('data-episode') || element.title || '';
                                    const episodeMatch = text.match(/(?:episodio|capitulo|cap|ep)?\s*([0-9]+)/i);
                                    if (episodeMatch && episodeMatch[1]) {
                                        const detectedEpisode = parseInt(episodeMatch[1]);
                                        if (detectedEpisode && detectedEpisode !== parseInt(window.episodeNumber) && detectedEpisode <= 50) { // Límite razonable
                                            console.log("[DETECCIÓN] Cambio detectado desde elemento DOM - Episodio:", detectedEpisode, "(selector:", selector, "texto:", text.substring(0, 50), ")");
                                            updateToNewEpisode(detectedEpisode);
                                            return; // Salir del bucle una vez encontrado
                                        }
                                    }
                                });
                            } catch (e) {
                                // Ignorar errores de selectores
                            }
                        });
                    }
                } catch (error) {
                    // Error de CORS esperado, continuar silenciosamente
                    // console.log("Error CORS (esperado):", error.message);
                }
            }, 500); // Verificar cada medio segundo para mejor detección
        }
        
        // Detener detección cuando sea necesario
        function stopContinuousDetection() {
            if (detectionInterval) {
                clearInterval(detectionInterval);
                detectionInterval = null;
            }
            
            if (mutationObserver) {
                mutationObserver.disconnect();
                mutationObserver = null;
                console.log("[MUTATION] Observer desconectado");
            }
        }
        
        // Iniciar detección cuando el iframe se carga
        animeIframe.addEventListener('load', () => {
            console.log("Iframe cargado, iniciando detección continua...");
            startContinuousDetection();
        });
        
        // Detener detección cuando se abandona la página
        window.addEventListener('beforeunload', stopContinuousDetection);
        
        // Detectar cambios en la URL (navegación manual, botón atrás/adelante)
        window.addEventListener('popstate', function(event) {
            console.log("[URL] Cambio de URL detectado (popstate)");
            updateParamsFromURL();
            
            // Recargar el episodio con los nuevos parámetros
            loadEpisode();
        });
        
        // También detectar cambios en la URL actual periódicamente
        let lastUrl = window.location.href;
        setInterval(() => {
            const currentUrl = window.location.href;
            if (currentUrl !== lastUrl) {
                console.log("[URL] Cambio de URL detectado (polling):", currentUrl);
                lastUrl = currentUrl;
                updateParamsFromURL();
                
                // Recargar el episodio con los nuevos parámetros
                loadEpisode();
            }
        }, 1000);
        
        // Botones de navegación
        homeButton.addEventListener('click', goToHome);
        nextEpisodeButton.addEventListener('click', goToNextEpisode);
        
        // Cargar el episodio inicial
        loadEpisode();
    </script>
</body>
</html>