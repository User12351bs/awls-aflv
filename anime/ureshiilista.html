<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UreshiiLista - Ureshii Anime</title>
    <link rel="stylesheet" href="index.css">
    <link rel="icon" href="logo.png" type="image/x-icon">
    <link rel="apple-touch-icon" href="logo.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ureshii Anime">
    <script src="glob/localstorage.js"></script>
    <script src="animes.js"></script>
    <link rel="stylesheet" href="glob/header.css">
    <script src="glob/header.js"></script>
    <link rel="stylesheet" href="glob/cards.css">
    <script src="glob/cards.js"></script>

    <style>
        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            padding: 0 20px;
        }
        
        .back-button {
            background-color: transparent;
            border: none;
            color: #888; /* Color gris */
            cursor: pointer;
            display: flex;
            align-items: center;
            font-size: 16px;
            text-decoration: none; /* Quitar subrayado del enlace */
            font-weight: bold; /* Texto en negrita */
            transition: color 0.3s ease; /* Añadir transición para el efecto hover */
        }
        
        .back-button:hover {
            color: #fff; /* Cambiar a blanco en hover */
        }
        
        .back-button svg {
            margin-right: 8px;
            width: 20px;
            height: 20px;
            fill: currentColor; /* Usar el color actual del texto */
            transform: rotate(180deg); /* Quitar la rotación para arreglar el error visual */
        }
        
        /* Estilos para el botón de configuración y su SVG */
        .settings-button {
            background-color: transparent;
            border: none;
            color: #888; /* Color gris igual que los enlaces */
            cursor: pointer;
            transition: color 0.3s ease; /* Misma transición que los enlaces */
        }
        
        .settings-button:hover {
            color: #fff; /* Cambiar a blanco en hover, igual que los enlaces */
        }
        
        .settings-button svg {
            width: 24px;
            height: 24px;
            fill: currentColor; /* Usar el color actual del texto */
        }
        
        .search-container {
            margin: 20px auto;
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            padding: 0 1rem;
            box-sizing: border-box;
        }
        
        .search-input-container {
            display: flex;
            position: relative;
            border-bottom: 2px solid #FF6B00;
            background-color: transparent !important;
            padding: 0.5rem 0;
            transition: all 0.3s ease;
            width: 100%;
            margin: 0 auto;
            box-shadow: none;
            border-radius: 8px 8px 0 0;
            overflow: visible;
        }
        
        .search-input {
            flex: 1;
            padding: 0.8rem 0;
            border: none;
            background-color: transparent !important;
            color: var(--text-color);
            font-size: 1.2rem;
            outline: none;
            width: calc(100% - 2.5rem);
        }
        
        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 40px;
            background-color: var(--card-color);
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            z-index: 100;
            min-width: 200px;
        }
        
        .dropdown-menu.show {
            display: block;
        }
        
        .dropdown-item {
            padding: 10px 15px;
            color: var(--text-color);
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .dropdown-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .empty-message {
            text-align: center;
            padding: 2rem 1rem 0.5rem 1rem;
            color: #aaa;
            font-size: 1.2rem;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .empty-link {
            color: #FF6B00;
            text-decoration: none;
            transition: color 0.3s ease;
        }
        
        .empty-link:hover {
            color: #FF8C40;
            text-decoration: underline;
        }

        .anime-grid.empty-results {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px;
        }

        .list-title {
            font-size: 24px;
            font-weight: normal; /* Quitar la negrita */
            margin: 20px 0;
            text-align: center; /* Centrar el título */
        }
        
        /* Estilos para resoluciones grandes */
        @media (min-width: 1600px) {
            /* Aumentar tamaño del título de la lista */
            .list-title {
                font-size: 42px !important; /* Forzar con !important */
                margin: 30px 0 !important; /* Forzar con !important */
            }
            
            /* Aumentar tamaño del botón de volver */
            .back-button {
                font-size: 24px !important; /* Forzar con !important */
            }
            
            .back-button svg {
                width: 30px !important; /* Forzar con !important */
                height: 30px !important; /* Forzar con !important */
                margin-right: 12px !important; /* Forzar con !important */
            }
            
            /* Aumentar tamaño del botón de configuración */
            .settings-button svg {
                width: 36px !important; /* Forzar con !important */
                height: 36px !important; /* Forzar con !important */
            }
            
            /* Aumentar tamaño del contenedor de búsqueda */
            .search-container {
                max-width: 1000px !important; /* Forzar con !important */
                gap: 2rem !important; /* Forzar con !important */
                padding: 0 2rem !important; /* Forzar con !important */
            }
            
            /* Aumentar tamaño del input de búsqueda */
            .search-input {
                font-size: 1.6rem !important; /* Forzar con !important */
                padding: 1rem 0 !important; /* Forzar con !important */
            }
            
            /* Aumentar tamaño de los elementos del menú desplegable */
            .dropdown-item {
                padding: 15px 20px !important; /* Forzar con !important */
                font-size: 18px !important; /* Forzar con !important */
            }
            
            /* Aumentar tamaño de los mensajes vacíos */
            .empty-message {
                font-size: 1.8rem !important; /* Forzar con !important */
                max-width: 900px !important; /* Forzar con !important */
                padding: 3rem 2rem 1.5rem 2rem !important; /* Forzar con !important */
            }
            
            /* Aumentar tamaño del enlace en mensajes vacíos */
            .empty-link {
                font-size: 1.8rem !important; /* Forzar con !important */
            }
            
            /* Aumentar el espacio para resultados vacíos */
            .anime-grid.empty-results {
                min-height: 400px !important; /* Forzar con !important */
            }
        }
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.7);
    }
    
    .modal-content {
        background-color: var(--card-color);
        margin: 10% auto;
        padding: 20px;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        position: relative;
    }
    
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        position: absolute;
        right: 20px;
        top: 10px;
    }
    
    .close:hover,
    .close:focus {
        color: var(--accent-color);
        text-decoration: none;
        cursor: pointer;
    }
    
    .modal-header {
        margin-bottom: 20px;
    }
    
    .modal-header h3 {
        margin: 0;
        color: var(--text-color);
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: var(--text-color);
    }
    
    .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #444;
        border-radius: 4px;
        background-color: #333;
        color: var(--text-color);
        font-size: 16px;
    }
    
    .modal-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
    }
    
    .modal-button {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        text-transform: uppercase;
    }
    
    .confirm-button {
        background-color: var(--accent-color);
        color: white;
    }
    
    .cancel-button {
        background-color: #444;
        color: white;
    }
    
    /* Estilo para el mensaje de error en los formularios */
    .error-message {
        color: #fff;
        font-size: 11px;
        padding: 6px 12px;
        background-color: rgba(255, 59, 48, 0.9);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 59, 48, 0.7);
        border-radius: 6px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        text-align: center;
        font-weight: 500;
        width: 70%;
        max-width: 300px;
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        bottom: -100px;
        z-index: 1000;
        transition: bottom 0.3s ease, opacity 0.3s ease;
        opacity: 0;
        pointer-events: none;
    }
    
    .error-message.show {
        bottom: 10px;
        opacity: 1;
    }
    
    /* Sobrescribir los estilos de error-message para modales */
    .modal .error-message {
        position: static;
        transform: none;
        top: auto;
        left: auto;
        font-size: 11px;
        padding: 6px 12px;
        background-color: rgba(255, 59, 48, 0.9);
        border: 1px solid rgba(255, 59, 48, 0.7);
        border-radius: 6px;
        margin-top: 5px;
        margin-bottom: 10px;
        width: auto;
        max-width: none;
        display: none;
    }
    
    .modal .error-message.show {
        display: block;
    }
    </style>
</head>
<body>
    <header>
        <div class="menu-button" id="menu-toggle">
            <svg class="menu-ab-svg--wDGx3 header-svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" data-t="menu-svg" aria-hidden="true" role="img"><path class="menu-ab-svg__top--Xgjtj" d="M20 5H4V7H20V5Z"></path><path class="menu-ab-svg__middle--vsB5D" d="M4 11H20V13H4V11Z"></path><path class="menu-ab-svg__bottom--6yklx" d="M20 17H4V19H20V17Z"></path></svg>
        </div>
        <a href="index.html" class="header-logo">
            <picture>
                <source media="(max-width: 768px)" srcset="logo.png">
                <source media="(min-width: 769px)" srcset="horizontal-logo.png">
                <img src="horizontal-logo.png" alt="Ureshii Anime" class="logo-img">
            </picture>
        </a>
        <div class="nav-categories">
            <a href="index.html" class="nav-category">Catálogo</a>
            <a href="novedades.html" class="nav-category">Novedades</a>
        </div>
        <div class="header-buttons">
            <a href="search.html" class="header-button">
                <svg class="header-svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" data-t="search-svg" aria-hidden="true" role="img"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5 19C12.4879 19 14.3164 18.3176 15.7641 17.1742L21.2927 22.7069L22.7074 21.2931L17.1778 15.7595C18.319 14.3126 19 12.4858 19 10.5C19 5.80558 15.1944 2 10.5 2C5.80558 2 2 5.80558 2 10.5C2 15.1944 5.80558 19 10.5 19ZM10.5 17C14.0899 17 17 14.0899 17 10.5C17 6.91015 14.0899 4 10.5 4C6.91015 4 4 6.91015 4 10.5C4 14.0899 6.91015 17 10.5 17Z"></path></svg>
            </a>
            <a href="ureshiilists.html" class="header-button">
                <svg class="header-svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" data-t="watchlist-svg" aria-hidden="true" role="img"><path fill-rule="evenodd" clip-rule="evenodd" d="M19.0001 20.5858C19.0001 21.4767 17.9229 21.9229 17.293 21.2929L12.0001 16L6.7071 21.2929C6.07714 21.9229 5 21.4767 5 20.5858L5.00006 3H19.0001V20.5858ZM7.00001 18.1716L7.00006 5H17.0001V18.1716L12.0001 13.1716L7.00001 18.1716Z"></path></svg>
            </a>
            <a href="account.html" class="export-button" id="export-import-button">
                <svg class="header-svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" data-t="user-settings-svg" aria-hidden="true" role="img"><path d="M12 20a6.01 6.01 0 0 1-5.966-5.355L12 12.088l5.966 2.557A6.01 6.01 0 0 1 12 20m0-16c1.654 0 3 1.346 3 3s-1.345 3-2.999 3h-.002A3.003 3.003 0 0 1 9 7c0-1.654 1.346-3 3-3m7.394 9.081l-4.572-1.959A4.997 4.997 0 0 0 17 7c0-2.757-2.243-5-5-5S7 4.243 7 7c0 1.71.865 3.22 2.178 4.122l-4.572 1.959A.999.999 0 0 0 4 14c0 4.411 3.589 8 8 8s8-3.589 8-8c0-.4-.238-.762-.606-.919"></path></svg>
            </a>
        </div>
    </header>

    <div class="container">
        <div class="list-header">
            <!-- Reemplazar el botón de volver -->
            <a href="ureshiilists.html" class="back-button" id="back-button">
                <svg class="angle--pJ1yZ angle--is-left--j9YOy navigation-link-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" data-t="angle-left-svg" aria-hidden="true" role="img">
                    <path d="M8.6 7.4L10 6l6 6-6 6-1.4-1.4 4.6-4.6z"></path>
                </svg>
                VOLVER A URESHIILISTAS
            </a>
            <button class="settings-button" id="settings-button">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path>
                </svg>
            </button>
            <div class="dropdown-menu" id="settings-menu">
                <div class="dropdown-item" id="rename-list">Renombrar la UreshiiList</div>
                <div class="dropdown-item" id="delete-list">Eliminar la UreshiiList</div>
            </div>
        </div>
        
        <h2 class="list-title" id="list-title">Nombre de la Lista</h2>
        
        <div class="search-container">
            <div class="search-input-container">
                <input type="text" class="search-input" id="search-input" placeholder="Buscar en la lista...">
            </div>
        </div>
        
        <div class="anime-grid" id="anime-grid"></div>
    </div>
    
    <!-- Modal para renombrar lista -->
    <div id="rename-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="modal-header">
                <h3>Renombrar UreshiiLista</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="new-list-name">Nuevo nombre</label>
                    <input type="text" id="new-list-name" class="form-control">
                    <div id="rename-error" class="error-message">Por favor, introduce un nombre para la lista</div>
                </div>
                <div class="modal-buttons">
                    <button id="rename-confirm" class="modal-button confirm-button">GUARDAR</button>
                    <button id="rename-cancel" class="modal-button cancel-button">CANCELAR</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para confirmar eliminación -->
    <div id="delete-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="modal-header">
                <h3>Eliminar UreshiiLista</h3>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que deseas eliminar esta lista? Esta acción no se puede deshacer.</p>
                <div class="modal-buttons">
                    <button id="delete-confirm" class="modal-button confirm-button">ELIMINAR</button>
                    <button id="delete-cancel" class="modal-button cancel-button">CANCELAR</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="notification" class="favorites-notification">
        <div class="favorites-notification-content">
            Acción completada correctamente
        </div>
    </div>
    
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const listId = urlParams.get('id');
        
        // Cargar listas del localStorage
        let ureshiiLists = JSON.parse(localStorage.getItem(URESHII_LISTS_KEY)) || [];
        
        // Encontrar la lista actual
        const currentList = ureshiiLists.find(list => list.id === listId);
        
        // Elementos del DOM
        const listTitle = document.getElementById('list-title');
        const animeGrid = document.getElementById('anime-grid');
        const backButton = document.getElementById('back-button');
        const settingsButton = document.getElementById('settings-button');
        const settingsMenu = document.getElementById('settings-menu');
        const renameList = document.getElementById('rename-list');
        const deleteList = document.getElementById('delete-list');
        const renameModal = document.getElementById('rename-modal');
        const deleteModal = document.getElementById('delete-modal');
        const newListName = document.getElementById('new-list-name');
        const renameConfirm = document.getElementById('rename-confirm');
        const renameCancel = document.getElementById('rename-cancel');
        const deleteConfirm = document.getElementById('delete-confirm');
        const deleteCancel = document.getElementById('delete-cancel');
        const searchInput = document.getElementById('search-input');
        const closeButtons = document.querySelectorAll('.close');
        
        // Añadir estilos para los botones de eliminar
        const addStyles = () => {
            if (!document.getElementById('delete-button-styles')) {
                const styles = document.createElement('style');
                styles.id = 'delete-button-styles';
                document.head.appendChild(styles);
            }
        };
        
        // Función para eliminar un anime de la lista actual
        function removeAnimeFromList(animeId) {
            // Obtener las listas donde está el anime
            const animeLists = ureshiiLists.filter(list => list.items.includes(Number(animeId)));
            
            // Si solo está en la lista actual, eliminarlo directamente
            if (animeLists.length === 1 && animeLists[0].id === currentList.id) {
                const index = currentList.items.indexOf(Number(animeId));
                if (index !== -1) {
                    // Encontrar y eliminar la tarjeta del DOM inmediatamente
                    const animeCards = document.querySelectorAll('.anime-card');
                    let cardToRemove = null;
                    animeCards.forEach(card => {
                        if (Number(card.dataset.animeId) === Number(animeId)) {
                            cardToRemove = card;
                        }
                    });
                    
                    // Eliminar la tarjeta con una animación de desvanecimiento
                    if (cardToRemove) {
                        cardToRemove.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
                        cardToRemove.style.opacity = '0';
                        cardToRemove.style.transform = 'scale(0.9)';
                        setTimeout(() => {
                            cardToRemove.remove();
                            // Verificar si el grid está vacío después de eliminar
                            if (animeGrid.children.length === 0) {
                                displayAnimes(); // Mostrar mensaje de vacío si es necesario
                            }
                        }, 300);
                    }
                    
                    // Eliminar de la lista de datos
                    currentList.items.splice(index, 1);
                    currentList.updatedAt = new Date().toISOString();
                    
                    // Guardar en localStorage
                    localStorage.setItem(URESHII_LISTS_KEY, JSON.stringify(ureshiiLists));
                    
                    // Verificar si el anime debe ser removido de myList
                    const isInOtherLists = ureshiiLists.some(list => list.id !== currentList.id && list.items.includes(Number(animeId)));
                    if (!isInOtherLists) {
                        let myList = JSON.parse(localStorage.getItem(MY_LIST_KEY)) || [];
                        const myListIndex = myList.indexOf(Number(animeId));
                        if (myListIndex !== -1) {
                            myList.splice(myListIndex, 1);
                            localStorage.setItem(MY_LIST_KEY, JSON.stringify(myList));
                            // Actualizar también window.myList
                            window.myList = myList;
                            
                            // Actualizar el estado del anime en animeData
                            const anime = animeData.find(a => a.id === animeId);
                            if (anime) {
                                anime.inMyList = false;
                            }
                        }
                    }
                    
                    // Ya no necesitamos llamar a displayAnimes() aquí porque ya actualizamos el DOM
                    showNotification('Anime eliminado de la lista');
                }
            } else {
                // Si está en múltiples listas, mostrar modal
                showMultiListDeleteModal(animeId, animeLists);
            }
        }
        
        // Función para mostrar el modal de eliminación de múltiples listas
        function showMultiListDeleteModal(animeId, lists) {
            // Crear el modal si no existe
            let multiListDeleteModal = document.getElementById('multi-list-delete-modal');
            if (!multiListDeleteModal) {
                multiListDeleteModal = document.createElement('div');
                multiListDeleteModal.id = 'multi-list-delete-modal';
                multiListDeleteModal.className = 'modal';
                
                // Crear el contenido del modal
                multiListDeleteModal.innerHTML = `
                    <div class="modal-content">
                        <span class="close">&times;</span>
                        <div class="modal-header">
                            <h3>Eliminar de listas</h3>
                        </div>
                        <div class="modal-body">
                            <p>Este anime está en varias listas. Selecciona de cuál quieres eliminarlo:</p>
                            <div id="multi-list-container" class="lists-container"></div>
                        </div>
                    </div>
                `;
                
                // Añadir el modal al body
                document.body.appendChild(multiListDeleteModal);
                
                // Añadir evento para cerrar el modal
                const closeButton = multiListDeleteModal.querySelector('.close');
                closeButton.addEventListener('click', () => {
                    multiListDeleteModal.style.display = 'none';
                });
                
                // Cerrar modal al hacer clic fuera del contenido
                window.addEventListener('click', (e) => {
                    if (e.target === multiListDeleteModal) {
                        multiListDeleteModal.style.display = 'none';
                    }
                });
            }
            
            // Generar elementos para cada lista
            const listsContainer = multiListDeleteModal.querySelector('#multi-list-container');
            listsContainer.innerHTML = '';
            
            lists.forEach(list => {
                const listItem = document.createElement('div');
                listItem.className = 'list-item-with-delete';
                
                const listName = document.createElement('div');
                listName.className = 'list-name';
                listName.textContent = list.name;
                
                const deleteButton = document.createElement('button');
                deleteButton.className = 'delete-from-list-button';
                deleteButton.innerHTML = `
                    <span class="tooltip">Eliminar</span>
                    <svg class="custom-list-card-delete-button__icon--pENvJ" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" data-t="trash-svg" aria-hidden="true" role="img">
                        <path d="M13 2h-2a1 1 0 0 0-1 1v1H4a1 1 0 0 0 0 2h1v15a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V6h1a1 1 0 1 0 0-2h-6V3a1 1 0 0 0-1-1m-1 2v2h5v14H7V6h5V4zm-2 5a1 1 0 0 0-1 1v6a1 1 0 1 0 2 0v-6a1 1 0 0 0-1-1zm4 0a1 1 0 0 0-1 1v6a1 1 0 1 0 2 0v-6a1 1 0 0 0-1-1z"></path>
                    </svg>
                `;
                
                deleteButton.addEventListener('click', () => {
                    // Eliminar anime de esta lista específica
                    const index = list.items.indexOf(Number(animeId));
                    if (index !== -1) {
                        list.items.splice(index, 1);
                        list.updatedAt = new Date().toISOString();
                        
                        // Guardar en localStorage
                        localStorage.setItem(URESHII_LISTS_KEY, JSON.stringify(ureshiiLists));
                        
                        // Verificar si el anime debe ser removido de myList
                        const isInAnyList = ureshiiLists.some(l => l.items.includes(Number(animeId)));
                        if (!isInAnyList) {
                            let myList = JSON.parse(localStorage.getItem(MY_LIST_KEY)) || [];
                            const myListIndex = myList.indexOf(Number(animeId));
                            if (myListIndex !== -1) {
                                myList.splice(myListIndex, 1);
                                localStorage.setItem(MY_LIST_KEY, JSON.stringify(myList));
                                // Actualizar también window.myList
                                window.myList = myList;
                                
                                // Actualizar el estado del anime en animeData
                                const anime = animeData.find(a => Number(a.id) === Number(animeId));
                                if (anime) {
                                    anime.inMyList = false;
                                }
                            }
                        }
                        
                        // Actualizar la visualización si estamos en la lista que se modificó
                        if (list.id === currentList.id) {
                            // Encontrar y eliminar la tarjeta del DOM inmediatamente
                            const animeCards = document.querySelectorAll('.anime-card');
                            let cardToRemove = null;
                            animeCards.forEach(card => {
                                if (Number(card.dataset.animeId) === Number(animeId)) {
                                    cardToRemove = card;
                                }
                            });
                            
                            // Eliminar la tarjeta con una animación de desvanecimiento
                            if (cardToRemove) {
                                cardToRemove.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
                                cardToRemove.style.opacity = '0';
                                cardToRemove.style.transform = 'scale(0.9)';
                                setTimeout(() => {
                                    cardToRemove.remove();
                                    // Verificar si el grid está vacío después de eliminar
                                    if (animeGrid.children.length === 0) {
                                        displayAnimes(); // Mostrar mensaje de vacío si es necesario
                                    }
                                }, 300);
                            }
                        }
                        
                        // Eliminar este elemento del modal
                        listItem.remove();
                        
                        // Si ya no hay elementos en el modal, cerrarlo
                        if (listsContainer.children.length === 0) {
                            multiListDeleteModal.style.display = 'none';
                        }
                        
                        showNotification('Anime eliminado de la lista');
                    }
                });
                
                listItem.appendChild(listName);
                listItem.appendChild(deleteButton);
                
                listsContainer.appendChild(listItem);
            });
            
            // Mostrar modal
            multiListDeleteModal.style.display = 'block';
        }
        
        // Inicializar la página
        function initPage() {
            if (!currentList) {
                // Si no se encuentra la lista, redirigir a la página de listas
                window.location.href = 'ureshiilists.html';
                return;
            }
            
            // Establecer el título de la lista
            listTitle.textContent = currentList.name;
            
            // Añadir estilos para los botones de eliminar
            addStyles();
            
            // Mostrar los animes de la lista
            displayAnimes();
            
            // Verificar si hay una notificación pendiente de lista recién creada
            const newListName = sessionStorage.getItem('newListName');
            if (newListName) {
                // Mostrar notificación después de un breve retraso para asegurar que la página esté cargada
                setTimeout(() => {
                    showNotification(`"${newListName}" creada correctamente`);
                    // Limpiar el sessionStorage
                    sessionStorage.removeItem('newListName');
                }, 100);
            }
        }
        
        // Mostrar animes de la lista
        function displayAnimes() {
            // Limpiar el grid
            animeGrid.innerHTML = '';
            
            // Obtener el término de búsqueda
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            // Filtrar animes por término de búsqueda
            let filteredAnimes = [];
            
            // Verificar si hay animes en la lista
            if (currentList && currentList.items && currentList.items.length > 0) {
                // Convertir IDs a números para comparación consistente
                const animeIds = currentList.items.map(id => Number(id));
                
                // Filtrar animes por término de búsqueda
                filteredAnimes = animeData.filter(anime => {
                    return animeIds.includes(Number(anime.id)) && 
                           (searchTerm === '' || anime.title.toLowerCase().includes(searchTerm));
                });
            }
            
            // Mostrar mensaje si no hay resultados 
            if (filteredAnimes.length === 0) { 
            // Cambiar la clase del grid para usar flex en lugar de grid 
            animeGrid.className = 'anime-grid empty-results'; 
            
            const emptyMessage = document.createElement('div'); 
            emptyMessage.className = 'empty-message'; 
            
            // Añadir el SVG grande encima del texto 
            const emptySvg = document.createElement('div'); 
            emptySvg.innerHTML = ` 
            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" data-t="error-svg" aria-hidden="true" role="img" style="width: 120px; height: 120px; margin-bottom: 20px; fill: #aaa;"> 
            <path d="M12.049 17.984l.9 2.7a.999.999 0 0 1-.95 1.317c-.418 0-.808-.265-.948-.684l-.9-2.7a1.847 1.847 0 0 0-2.334-1.168l-2.701.9a1 1 0 0 1-.632-1.897l2.7-.9a3.85 3.85 0 0 1 4.865 2.432zm9.9-6.3a1 1 0 0 1-.632 1.265l-2.701.9a1.848 1.848 0 0 0-1.167 2.335l.9 2.7a.999.999 0 0 1-.95 1.317c-.418 0-.808-.265-.948-.684l-.9-2.7a3.85 3.85 0 0 1 2.433-4.865l2.7-.9a.998.998 0 0 1 1.265.632zm-13.5-4.5a3.85 3.85 0 0 1-2.432 4.865l-2.7.9a.999.999 0 0 1-1.265-.632.999.999 0 0 1 .632-1.265l2.7-.9a1.85 1.85 0 0 0 1.168-2.335l-.9-2.7a1 1 0 1 1 1.897-.633l.9 2.7zm3.502-1.167l-.9-2.7a.999.999 0 0 1 .632-1.265 1 1 0 0 1 1.266.632l.9 2.7a1.85 1.85 0 0 0 2.334 1.168l2.701-.9a1 1 0 0 1 .632 1.897l-2.7.9a3.832 3.832 0 0 1-1.213.198 3.854 3.854 0 0 1-3.652-2.63z"></path> 
            </svg> 
            `; 
            
            emptyMessage.appendChild(emptySvg); 
            
            // Añadir el texto del mensaje 
            const messageText = document.createElement('div'); 
            if (searchTerm) { 
            messageText.textContent = 'No se encontraron resultados para tu búsqueda.'; 
            } else { 
            // Usar innerHTML para poder incluir el enlace 
            messageText.innerHTML = 'Puedes añadir elementos a esta UreshiiLista usando la <a href="search.html" class="empty-link">búsqueda</a> o desde la <a href="index.html" class="empty-link">página de cualquier anime</a>.'; 

            } 
            
            emptyMessage.appendChild(messageText); 
            animeGrid.appendChild(emptyMessage); 
            return; 
            } else {
                // Asegurarse de que el grid tenga la clase correcta cuando hay resultados
                animeGrid.className = 'anime-grid';
            }
            
            // Mostrar animes filtrados
            filteredAnimes.forEach(anime => {
                const card = createAnimeCard(anime);
                
                animeGrid.appendChild(card);
            });
        }
        
        // Buscar animes
        searchInput.addEventListener('input', () => {
            displayAnimes();
        });
        
        // Mostrar notificación
        function showNotification(message) {
            const notification = document.getElementById('notification');
            const notificationContent = notification.querySelector('.favorites-notification-content');
            
            notificationContent.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Inicializar la página
        initPage();

        // Crear elemento para notificaciones flotantes de error 
        let errorNotification = document.createElement('div'); 
        errorNotification.id = 'ureshii-error-notification'; 
        document.body.appendChild(errorNotification); 
        
        // Función mejorada para mostrar mensajes de error 
        function showErrorMessage(errorElement) { 
            // Si es un elemento dentro de un modal, mostrar inline 
            if (errorElement.closest('.modal')) { 
                errorElement.classList.add('show'); 
                
                // Ocultar automáticamente después de 5 segundos 
                setTimeout(() => { 
                    errorElement.classList.remove('show'); 
                }, 5000); 
            } else { 
                // Si no está en un modal, usar la notificación flotante 
                errorNotification.textContent = errorElement.textContent; 
                errorNotification.classList.add('show'); 
                
                // Ocultar automáticamente después de 5 segundos 
                setTimeout(() => { 
                    errorNotification.classList.remove('show'); 
                }, 5000); 
            } 
        } 
        
        // Manejar el botón de configuración y el menú desplegable 
        settingsButton.addEventListener('click', (e) => { 
            e.stopPropagation(); // Evitar que el clic se propague al documento 
            
            // Alternar la visibilidad del menú desplegable 
            if (settingsMenu.classList.contains('show')) { 
                settingsMenu.classList.remove('show'); 
            } else { 
                // Cerrar otros menús desplegables si están abiertos 
                document.querySelectorAll('.dropdown-menu.show').forEach(menu => { 
                    if (menu !== settingsMenu) { 
                        menu.classList.remove('show'); 
                    } 
                }); 
                
                // Mostrar el menú 
                settingsMenu.classList.add('show'); 
                
                // Posicionar el menú correctamente 
                const rect = settingsButton.getBoundingClientRect(); 
                settingsMenu.style.position = 'fixed'; 
                settingsMenu.style.top = `${rect.bottom}px`; 
                settingsMenu.style.right = `${window.innerWidth - rect.right}px`; 
            } 
        }); 
        
        // Asegurarse de que los clics en el SVG y su path también activen el menú 
        const settingsSvg = settingsButton.querySelector('svg'); 
        const settingsSvgPath = settingsButton.querySelector('svg path'); 
        
        if (settingsSvg) { 
            settingsSvg.addEventListener('click', (e) => { 
                e.stopPropagation(); 
                // Simular clic en el botón padre 
                settingsButton.click(); 
            }); 
        } 
        
        if (settingsSvgPath) { 
            settingsSvgPath.addEventListener('click', (e) => { 
                e.stopPropagation(); 
                // Simular clic en el botón padre 
                settingsButton.click(); 
            }); 
        } 
        
        // Manejar los elementos del menú desplegable 
        renameList.addEventListener('click', () => { 
            // Mostrar el modal de renombrar 
            renameModal.style.display = 'block'; 
            // Establecer el valor actual del nombre de la lista 
            newListName.value = currentList.name; 
            // Ocultar el menú desplegable 
            settingsMenu.classList.remove('show'); 
        }); 
        
        deleteList.addEventListener('click', () => { 
            // Mostrar el modal de eliminar 
            deleteModal.style.display = 'block'; 
            // Ocultar el menú desplegable 
            settingsMenu.classList.remove('show'); 
        }); 
        
        // Cerrar el menú desplegable al hacer clic en cualquier parte del documento 
        document.addEventListener('click', () => { 
            settingsMenu.classList.remove('show'); 
        }); 
        
        // Eventos para el modal de renombrar 
        renameCancel.addEventListener('click', () => { 
            renameModal.style.display = 'none'; 
            document.getElementById('rename-error').classList.remove('show'); 
        }); 
        
        renameConfirm.addEventListener('click', () => { 
            const newName = newListName.value.trim(); 
            const errorMessage = document.getElementById('rename-error'); 
            
            if (!newName) { 
                // Mostrar mensaje de error 
                showErrorMessage(errorMessage); 
                return; 
            } 
            
            // Ocultar mensaje de error 
            errorMessage.classList.remove('show'); 
            
            // Actualizar el nombre de la lista 
            currentList.name = newName; 
            currentList.updatedAt = new Date().toISOString(); 
            
            // Actualizar el título en la página 
            listTitle.textContent = newName; 
            
            // Guardar en localStorage 
            localStorage.setItem(URESHII_LISTS_KEY, JSON.stringify(ureshiiLists)); 
            
            // Cerrar modal 
            renameModal.style.display = 'none'; 
            
            // Mostrar notificación 
            showNotification('Lista renombrada correctamente'); 
        }); 
        
        // Eventos para el modal de eliminar 
        deleteCancel.addEventListener('click', () => { 
            deleteModal.style.display = 'none'; 
        }); 
        
        deleteConfirm.addEventListener('click', () => { 
            // Encontrar el índice de la lista actual 
            const listIndex = ureshiiLists.findIndex(list => list.id === listId); 
            
            if (listIndex !== -1) { 
                // Obtener los IDs de los animes en la lista antes de eliminarla
                const animesInList = [...ureshiiLists[listIndex].items];
                
                // Eliminar la lista 
                ureshiiLists.splice(listIndex, 1); 
                
                // Actualizar myList en localStorage eliminando los animes que solo estaban en esta lista
                let myList = JSON.parse(localStorage.getItem(MY_LIST_KEY)) || [];
                
                // Para cada anime en la lista eliminada
                animesInList.forEach(animeId => {
                    // Verificar si el anime está en otras listas
                    const isInOtherLists = ureshiiLists.some(list => list.items.includes(Number(animeId)));
                    
                    if (!isInOtherLists) {
                        // Si no está en otras listas, eliminarlo de myList
                        const myListIndex = myList.indexOf(Number(animeId));
                        if (myListIndex !== -1) {
                            myList.splice(myListIndex, 1);
                            
                            // Actualizar el estado del anime en animeData
                            const anime = animeData.find(a => a.id === animeId);
                            if (anime) {
                                anime.inMyList = false;
                            }
                        }
                    }
                });
                
                // Guardar myList actualizada
                localStorage.setItem(MY_LIST_KEY, JSON.stringify(myList));
                // Actualizar también window.myList para mantener sincronizado
                window.myList = myList;
                
                // Guardar en localStorage 
                localStorage.setItem(URESHII_LISTS_KEY, JSON.stringify(ureshiiLists)); 
                
                // Redirigir a la página de listas 
                window.location.href = 'ureshiilists.html'; 
            } 
        }); 
        
        // Cerrar modales al hacer clic en X 
        closeButtons.forEach(button => { 
            button.addEventListener('click', () => { 
                renameModal.style.display = 'none'; 
                deleteModal.style.display = 'none'; 
                document.getElementById('rename-error').classList.remove('show'); 
            }); 
        }); 
        
        // Cerrar modales al hacer clic fuera del contenido 
        window.addEventListener('click', (e) => { 
            if (e.target === renameModal) { 
                renameModal.style.display = 'none'; 
                document.getElementById('rename-error').classList.remove('show'); 
            } 
            if (e.target === deleteModal) { 
                deleteModal.style.display = 'none'; 
            } 
        });
        
        // Cargar datos desde Google Drive si está disponible
        if (typeof window.loadInitialDataFromDrive === 'function') {
            window.loadInitialDataFromDrive();
        }
        
        // Escuchar cuando los datos de Drive estén listos
        window.addEventListener('driveDataReady', function(event) {
            console.log('Datos de Google Drive cargados en ureshiilista.html:', event.detail);
            // Recargar contenido que dependa de los datos
            if (typeof displayList === 'function') {
                displayList();
            }
        });
    </script>
</body>
</html>




